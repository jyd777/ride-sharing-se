<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>添加车牌</title>
    <script src="https://kit.fontawesome.com/1a8c6dd550.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../static/car_register_car_owner.css">
    <link rel="stylesheet" href="../static/info_box.css">
    <link rel="stylesheet" href="../static/header_car_owner.css">
    
    <script src="../static/info_box.js"></script>
    <!-- 引入 jQuery UI 的 CSS 文件 -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
</head>
<body>
    <header>
        <h2 class="logo">SmartPark 济智停</h2>
    </header>

    <div class="shell">
        <!-- 导航菜单 -->
        <ul class="nav">
            <li class="active" id="logo">
                <a href="#">
                    <div class="icon">
<div class="imageBox">
    <img id="userImage" src="" alt="User Image">
</div>
                    </div>
                    <div class="text">jyd777</div>
                </a>
            </li>
            <li>
                <a href="#person_page">
                    <div class="icon">
                        <i class="fa-solid fa-house-chimney-window"></i>
                    </div>
                    <div class="text">个人主页</div>
                </a>
            </li>
            <li>
                <a href="#carport_info">
                    <div class="icon">
                        <i class="fa-solid fa-square-parking"></i>
                    </div>
                    <div class="text">停车场查询</div>
                </a>
            </li>
            <li>
                <a href="#order_manage">
                    <div class="icon">
                        <i class="fa-solid fa-clipboard"></i>
                    </div>
                    <div class="text">订单管理</div>
                </a>
            </li>
            <li>
                <a href="#carpots">
                    <div class="icon">
                        <i class="fa-solid fa-car"></i>
                    </div>
                    <div class="text">停车场信息查看</div>
                </a>
            </li>
        </ul>
    </div>

    <div class="wrapper">
        <div class="personal-info">
            <!-- 用户头像容器 -->
            <div class="user-avatar-container">
                <img id="avatar" src="" alt="用户头像" class="user-avatar" onclick="document.getElementById('fileInput').click();">
                <input type="file" id="fileInput" style="display: none;" accept="image/jpeg, image/png">
            </div>
            <div class="info-container">
                <!-- 动态生成的个人信息项将在这里显示 -->
            </div>
                        <!-- 停车信息表格 -->
        <div class="info-container"style="margin-top: 30px;">
 <table id="parkingInfoTable" class="table">
    <thead class="custom-table-header">
        <tr>
            <th style="background-color: #007bff; color: white;">车牌号</th>
            <th style="background-color: #007bff; color: white;">停车时间</th>
            <th style="background-color: #007bff; color: white;">停车场位置</th>
            <th style="background-color: #007bff; color: white;">车位编号</th>
          </tr>
    </thead>
    <tbody>
      <!-- 停车信息动态添加 -->
    </tbody>
  </table>
        </table>
        </div>
        </div>

        <div class="container">
            <h2>我的车牌</h2>
            <!-- 已登记的车牌列表 -->
            <div id="plateList">
                <!-- 动态加载的车牌信息将在这里插入 -->
            </div>
            <!-- 添加车牌按钮 -->
            <button class="add-plate-button">+ 添加车牌</button>
        </div>
    </div>

<!-- 添加车牌模态窗口 -->
<div id="myModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>添加车牌</h2>
        <form id="plateForm">
            <div class="form-group">
                <label for="plateNumber">车牌号码:</label>
                <div id="plateNumberInputs">
                    <!-- 车牌号码选择框将通过JavaScript动态生成 -->
                 </div>
            </div>
            <div class="form-group">
                <label for="plateColor">车牌颜色:</label>
                <select id="plateColor">
                    <option value="blue">蓝牌</option>
                    <option value="yellow">黄牌</option>
                    <option value="white">白牌</option>
                    <option value="black">黑牌</option>
                    <option value="green">绿牌</option>
                    <option value="yellow-green">黄绿牌</option>
                    <option value="temporary">临牌</option>
                </select>
            </div>
            <div class="form-group" id="plateColorOptions"></div> <!-- 新增此行 -->
            <button type="submit">确定</button>
        </form>
    </div>
</div>
    <div id="calendar"></div>
    <input type="file" id="fileInput" style="display: none;">
    <script>
$(function() {
    // 初始化日期选择器为展示类型
    $("#calendar").datepicker({
        inline: true, // 使日历嵌入到页面中
        showOtherMonths: true, // 显示其他月份的日期
        selectOtherMonths: true, // 允许选择其他月份的日期
        navigationAsDateFormat: true, // 导航头部显示为日期格式
        changeMonth: true, // 允许改变月份
        changeYear: true, // 允许改变年份
        showButtonPanel: true // 显示按钮面板
    });
});

document.addEventListener('DOMContentLoaded', function () {
    // 获取停车信息
    console.log('获取停车信息');
    fetch('/api/parking-records')
        .then(response => response.json())
        .then(data => {
            if (data) {
                const parkingInfoData = data.data;
                const parkingInfoTableBody = document.querySelector('#parkingInfoTable tbody');
                parkingInfoTableBody.innerHTML = ''; // 清空现有内容
                console.log('获取停车信息成功:', parkingInfoData);
                parkingInfoData.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.plateNumber}</td>
                        <td>${record.time}</td>
                        <td>${record.location}</td>
                        <td>${record.spotNumber}</td>
                    `;
                    parkingInfoTableBody.appendChild(row);
                });
            } else {
                console.error('获取停车信息失败:', data.msg);
            }
        })
        .catch(error => console.error('请求失败:', error));
});

document.addEventListener('DOMContentLoaded', function() {
    const wrapper = document.querySelector('.wrapper');
    const personalInfo = document.querySelector('.personal-info');
    const avatarContainer = document.querySelector('.user-avatar-container');
    const avatar = document.getElementById('avatar');
    const fileInput = document.getElementById('fileInput');
    const infoContainer = document.querySelector('.info-container');
    const parkingInfoTableBody = document.querySelector('#parkingInfoTable tbody');

    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && (file.type === 'image/jpeg' || file.type === 'image/png')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                avatar.src = e.target.result;
            };
            reader.readAsDataURL(file);

            // 创建FormData对象并添加文件
            const formData = new FormData();
            formData.append('image', file);

            // 发送文件到后端
            fetch('/upload-image', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message); // 提示用户上传成功
                    location.reload();
                } else if (data.error) {
                    alert(data.error); // 提示用户上传失败
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('上传过程中发生错误，请重试。');
            });
        } else {
            alert('请选择JPG或PNG格式的图片文件！');
            fileInput.value = '';
        }
    });

    // 发送请求到后端获取用户信息
    let personalInfoData = {};
    fetch('/get-user-avatar')
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Network response was not ok.');
        })
        .then(data => {
            console.log(data);
            if (data && !data.error) {
                avatar.src = data.image;
            } else {
                console.error(data.error || 'No avatar found');
                avatar.src = '/static/pic/user.jpg';  // 默认图片
            }
        })
        .catch(error => {
            console.error('There has been a problem with your fetch operation:', error);
            avatar.src = '/static/pic/user.jpg';  // 默认图片
        });

    fetch('/get-user-info')
        .then(response => {
            if (response.ok) {
                return response.json(); // 假设后端返回的是JSON对象
            }
            throw new Error('Network response was not ok.');
        })
        .then(data => {
            if (data && !data.error) {
                personalInfoData = {
                    username: data.username,
                    gender: data.gender || "请设置性别", // 假设后端返回了gender字段
                    phone: data.phone || "" // 假设后端返回了phone字段
                };
                console.log(personalInfoData);
                const labelMap = {
                    username: '用户名',
                    gender: '性别',
                    phone: '电话'
                };
                Object.keys(personalInfoData).forEach(key => {
                    if (key !== 'avatar') {
                        const infoItem = document.createElement('div');
                        infoItem.className = 'info-item';

                        const label = document.createElement('span');
                        label.className = 'label';
                        label.textContent = labelMap[key] || key;
                        label.setAttribute('data-key', key); // 添加 data-key 属性

                        const colon = document.createTextNode('  ');

                        const value = document.createElement('span');
                        value.className = 'value';
                        value.textContent = personalInfoData[key];

                        infoItem.appendChild(label);
                        infoItem.appendChild(colon);
                        infoItem.appendChild(value);
                        infoContainer.appendChild(infoItem);
                    }
                });

                // 创建编辑按钮并添加事件监听
                const editButton = document.createElement('button');
                editButton.textContent = '修改信息';
                editButton.className = 'edit-button';
                infoContainer.appendChild(editButton);

                let isEditMode = false;
                editButton.addEventListener('click', function() {
                    isEditMode = !isEditMode;
                    editButton.textContent = isEditMode ? '保存修改' : '修改信息';

                    const valueSpans = infoContainer.querySelectorAll('.value, input[type="text"]');

                    Array.from(valueSpans).forEach(element => {
                        if (isEditMode && element.tagName === 'SPAN') {
                            const value = element.textContent;
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.value = value;
                            element.parentNode.replaceChild(input, element);
                        } else if (!isEditMode && element.tagName === 'INPUT') {
                            const value = element.value;
                            const span = document.createElement('span');
                            span.className = 'value';
                            span.textContent = value;

                            // 使用 data-key 属性获取键值
                            const labelElement = element.parentNode.querySelector('.label');
                            if (labelElement) {
                                const key = labelElement.getAttribute('data-key');
                                if (key) {
                                    personalInfoData[key] = value;
                                }
                            } else {
                                console.error('Label element not found in the container.');
                            }

                            element.parentNode.replaceChild(span, element);
                        }
                    });

                    // 如果是保存修改，发送数据到后端
                    if (!isEditMode) {
                        console.log('Sending data to backend:', personalInfoData); // 添加日志
                        // 发送 JSON 数据到后端
                        fetch('/update-user-info', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(personalInfoData)
                        })
                        .then(response => {
                            if (response.ok) {
                                return response.json();
                            }
                            throw new Error('Network response was not ok.');
                        })
                        .then(data => {
                            console.log('User info updated successfully', data);
                            alert('用户信息更新成功！');
                        })
                        .catch(error => {
                            console.error('There has been a problem with your fetch operation:', error);
                            alert('用户信息更新失败，请重试！');
                        });
                    }
                });
            } else {
                console.error(data.error || 'No user info found');
            }
        })
        .catch(error => {
            console.error('There has been a problem with your fetch operation:', error);
        });

    // 动态创建车牌列表
    const plateList = document.getElementById('plateList');
    // 获取用户车辆信息
    fetch('/get-user-cars')
        .then(response => response.json())
        .then(data => {
            const plateList = document.getElementById('plateList');
            if (data && data.cars) {
                data.cars.forEach(plate => {
                    const plateItem = document.createElement('div');
                    plateItem.className = 'plate-item';

                    const icon = document.createElement('i');
                    icon.className = 'fa-solid fa-car';

                    const plateNumber = document.createTextNode(plate.number);
                    console.log(plateNumber);
                    const colorBadge = document.createElement('span');
                    colorBadge.className = 'color-badge';
                    colorBadge.style.backgroundColor = plate.color; // 根据车牌颜色设置背景颜色
                    colorBadge.style.border = '2px solid rgb(100, 100, 100)'; // 设置黑色边框

                    const unbindButton = document.createElement('button');
                    unbindButton.textContent = '解绑车牌';
                    unbindButton.className = 'unbind-button';
                    unbindButton.style.marginLeft = '10px';
                    unbindButton.dataset.carId = plate.number;

                    unbindButton.addEventListener('click', function() {
                        const carId = this.dataset.carId;
                        console.log(carId);
                        if (confirm('确定要解绑车牌吗？')) {
                            fetch(`/delete-car/${encodeURIComponent(carId)}`, {
                                method: 'DELETE'
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.message === '车牌解绑成功') {
                                    alert('车牌解绑成功！');
                                    plateItem.remove(); // 从页面中移除该车牌项
                                } else {
                                    alert('车牌解绑失败：' + data.error);
                                }
                            })
                            .catch(error => {
                                console.error('There has been a problem with your fetch operation:', error);
                                alert('车牌解绑失败，请重试！');
                            });
                        }
                    });
                    plateItem.appendChild(icon);
                    plateItem.appendChild(plateNumber);
                    plateItem.appendChild(colorBadge);
                    plateItem.appendChild(unbindButton);

                    plateList.appendChild(plateItem);
                });
            }
        })
        .catch(error => console.error('Error fetching user cars:', error));

    // 创建车牌号码选择框
    const plateNumberInputs = document.getElementById('plateNumberInputs');
    const provinces = ['沪', '京', '津', '渝', '冀', '晋', '辽', '吉', '黑', '苏', '浙', '皖', '闽', '赣', '鲁', '豫', '鄂', '湘', '粤', '琼', '川', '贵', '云', '陕', '甘', '青', '蒙', '桂', '宁', '新', '藏', '港', '澳'];
    const lettersNumbers = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'.split('');

    for (let i = 0; i < 7; i++) {
        const select = document.createElement('select');
        select.className = 'plate-select';
        select.id = 'plateInput' + i;

        if (i === 0) {
            for (const province of provinces) {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                select.appendChild(option);
            }
        } else {
            for (const ln of lettersNumbers) {
                const option = document.createElement('option');
                option.value = ln;
                option.textContent = ln;
                select.appendChild(option);
            }
        }

        plateNumberInputs.appendChild(select);
    }

    // 添加车牌模态窗口
    const modal = document.getElementById("myModal");
    const span = document.getElementsByClassName("close")[0];
    const addPlateButton = document.querySelector('.add-plate-button');

    // 显示模态窗口
    addPlateButton.addEventListener('click', function() {
        modal.style.display = "block";
    });

    // 点击 <span> (x) 关闭模态窗口
    span.onclick = function() {
        modal.style.display = "none";
    }

    // 点击窗口外的区域关闭模态窗口
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    // 阻止表单默认提交行为
    const plateForm = document.getElementById('plateForm');
    plateForm.addEventListener('submit', function(event) {
        event.preventDefault();
        addPlate();
    });
});

function addPlate() {
    const plateInputs = document.querySelectorAll('.plate-select');
    let plateNumber = '';
    plateInputs.forEach(input => {
        plateNumber += input.value;
    });

    const plateColor = document.getElementById('plateColor').value;

    if (!plateNumber || !plateColor) {
        alert('请填写完整的车牌信息和颜色！');
        return;
    }

    const carData = {
        license_number: plateNumber,
        car_board_color: plateColor
    };

    fetch('/add-car', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(carData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message === '车牌添加成功') {
            alert('车牌添加成功！');
            location.reload();
        } else {
            alert('车牌添加失败：' + data.error);
        }
    })
    .catch(error => {
        console.error('There has been a problem with your fetch operation:', error);
        alert('车牌添加失败，请重试！');
    });
}
    </script>
    </body>
    </html>
